<style scoped>
.html-widget {
  border: 1px solid #ececec;
  background-color: #ececec;
}

.html-widget .credit {
  padding: 5px 5px 0;
  margin-bottom: 0;
}

.html-widget .caption {
  padding: 5px 5px 4px;
  margin-bottom: 10px;
}

.outerwrapper {
  width: 100%;
  position: relative;
  background-color: #fff;
}
.outerwrapper h2 {
  margin: 0;
  padding: 15px 2.5% 10px;
}
.outerwrapper p {
  margin: 0;
  padding: 10px 2.5% 10px;
}
.outerwrapper input {
  width: 100%;
}
.outerwrapper canvas {
  cursor: col-resize;
  transition: opacity 0.8s;
  opacity: 1;
}
.outerwrapper .canvasInvisible {
  opacity: 0;
}
.outerwrapper .widget-images ul {
  padding-left: 0;
}
.outerwrapper .widget-images li {
  list-style: none;
}
.outerwrapper .widget-selector {
  padding: 0 2.5% 0;
  margin: 10px 0 0;
}
.outerwrapper .widget-canvas {
  position: relative;
  margin: 0 2.5%;
}

</style>
<!--[if gt IE 8]><!-->
<style>
.js-enabled .widget-images {
	display: none;
}
</style>
<!--<![endif]-->

<div class="outerwrapper" id="slider-1">
	<h2>The Mittivakkat Glacier</h2>

	<div class="widget-canvas"></div>
	<div class="widget-selector"></div>

	<div class="widget-images">
		<ul>
			<li>
				<img src="http://www.nature.com/polopoly_fs/7.38030.1469528191!/image/montage-107a.jpg" alt="The Mittivakkat Glacier in 1933."/>
				<p>The Mittivakkat Glacier in 1933.</p>
			</li>
			<li>
				<img src="http://www.nature.com/polopoly_fs/7.38031.1469528304!/image/montage-107b.jpg" alt="The Mittivakkat Glacier in 2010." />
				<p>The Mittivakkat Glacier in 2010.</p>
			</li>
		</ul>
	</div>

	<p>The Mittivakkat Glacier has melted considerably since it was photographed by Danish researchers in 1933. Move the slider  to see the glacier in 2010, when it was photographed by a team from the University of Copenhagen and Aarhus University.</p>
</div>

<div class="outerwrapper" id="slider-2">
	<h2>The Tunu Glacier</h2>

	<div class="widget-canvas"></div>
	<div class="widget-selector"></div>
	<div class="widget-images">
		<ul>
			<li>
				<img src="http://www.nature.com/polopoly_fs/7.38032.1469528322!/image/montage-108a.jpg" alt="The Tunu Glacier in 1933."/>
				<p>The Tunu Glacier in 1933.</p>
			</li>
			<li>
				<img src="http://www.nature.com/polopoly_fs/7.38033.1469528340!/image/montage-108b.jpg" alt="The Tunu Glacier in 2010." />
				<p>The Tunu Glacier in 1933.</p>
			</li>
		</ul>
	</div>

	<p>The Tunu Glacier has retreated about 1500 meters since 1933. Move the slider to see the site in 2010, when the valley was almost free of ice.</p>

</div>
<p class="credit">Natural History Museum of Denmark; Hans Henrik Tholstrup/Natural History Museum of Denmark</p>

<!--[if gt IE 8]><!-->
<script type="text/javascript">
/*	buildParams()
	create an object to store all the parameters for the slider */
function buildParams() {
	var params = {};

	/* Array to store the images */
	params.allImages = [];

	/* Store with window Width to stop iOS resizing on scroll */
	params.windowWidth = jQuery(window).width();
	
	params.range = null;
	params.select = null;
	params.startingValue = 0;
	params.value = 0;
	params.widthAdjustment = 0.95;
	params.heightRatio = 0.6667;
	params.strokeStyle = "#ffffff";
	params.lineWidth = 2;
	params.loadError = false;

	var size = getCanvasSize(params.widthAdjustment, params.heightRatio);

	params.width = size.width;
	params.height = size.height;

	params.touchSupported = 'ontouchstart' in window;
	params.startEvent = params.touchSupported ? 'touchstart' : 'mousedown';
	params.moveEvent = params.touchSupported ? 'touchmove' : 'mousemove';
	params.endEvent = params.touchSupported ? 'touchend' : 'mouseup';
	params.mouseDown = false;

	return params;
}

function getCanvasSize(widthAdjustment, heightRatio) {

	var width = Math.floor(jQuery("#content").width() * widthAdjustment);
	var height = Math.floor(width * heightRatio);

	return {
		width: width,
		height: height
	};
}

/*	Constructor to create an object for each slider */
function BuildWidget(target, params) {
	this.target = target;
	this.params = params;

	this.outerWrapper = jQuery(target);
	this.imageCanvas = jQuery("<canvas></canvas>");
	this.rangeInput = jQuery("<input />");
	this.ctx = null;
}

/*	destroy()
	If it's not possible to build the canvas or the slider
	remove them both and show the original images */
BuildWidget.prototype.destroy = function() {

	this.imageCanvas.remove();
	this.rangeInput.remove();
	this.widgetImages.css("display","block");
};

/*	resize()
	Redraw and resize the canvas if the window width changes */
BuildWidget.prototype.resizeCanvas = function() {
	var self = this;
	
	if(jQuery(window).width() != this.params.windowWidth) {
		
		this.params.windowWidth = jQuery(window).width();

		var size = getCanvasSize(this.params.widthAdjustment, this.params.heightRatio);

		this.params.width = size.width;
		this.params.height = size.height;

		this.imageCanvas.attr({
			"width": this.params.width,
			"height": this.params.height
		});

		this.ctx.strokeStyle = "#ffffff";
		this.ctx.lineWidth = 2;

		this.params.value = this.params.startingValue;
		this.rangeInput.prop("value", this.params.value);

		this.drawFrame();
	}
};

/*	buildCanvas()
	create the canvas and add event listeners for mouse and touch */
BuildWidget.prototype.buildCanvas = function() {
	var self = this;

	this.imageCanvas.attr({
		"width": self.params.width,
		"height": self.params.height
	}).addClass("canvasInvisible");

	this.outerWrapper.find(".widget-canvas")
		.append(self.imageCanvas);

	this.ctx = this.imageCanvas[0].getContext("2d");

	this.ctx.strokeStyle = this.params.strokeStyle;
	this.ctx.lineWidth = this.params.lineWidth;

	jQuery("body").bind(this.params.startEvent, function() {
		self.params.mouseDown = true;
	});

	jQuery("body").bind(this.params.endEvent, function() {
		self.params.mouseDown = false;
	});

	/* Listen for click 'n drag or swiping on the canvas */
	this.imageCanvas.bind(this.params.moveEvent, function (evt) {
		
		var mousePos = self.getMousePos(evt);
		self.params.value = mousePos.x / self.params.width;
		
		if (self.params.mouseDown) {
			self.drawFrame();
			self.rangeInput.prop("value", self.params.value);
		}
	});
};

/*	getMousePos(canvas, evt)
	Find out where the finger or the pointer is on the canvas */
BuildWidget.prototype.getMousePos = function(evt) {
	var rect = this.imageCanvas[0].getBoundingClientRect();
	var x,y;
	
	if (this.params.touchSupported) {
		x = evt.originalEvent.targetTouches[0].clientX;
		y = evt.originalEvent.targetTouches[0].clientY;
	} else {
		x = evt.clientX;
		y = evt.clientY;
	}
	
	return {
		x: x - rect.left,
		y: y - rect.top
	};
};

/*	loadImages()
	If the images are loaded, store them in the allImages array
	if there is a problem destroy the canvas and slider */
BuildWidget.prototype.loadImages = function() {
	var self = this;
	this.widgetImages = this.outerWrapper.find(".widget-images");
		
	/*	Select each of the images and push a new img object into
		the allImages array with the relevant src */
	this.images = this.widgetImages.find("img");
	
	var imageCount = this.images.length;

	function checkImagesLoaded() {
		if (self.params.loadError === false) {
			imageCount--;
		}
		
		if (imageCount === 0) {
			self.drawFrame();
			self.imageCanvas.removeClass("canvasInvisible");
		}
	}

	jQuery.each(self.images, function (key, value) {

		var thisImage = new Image();
		thisImage.src = this.src;
		self.params.allImages.push(thisImage);
		
		jQuery(this).load(checkImagesLoaded())
			.error(function(evt) {
				self.params.loadError = true;
				self.destroy();
			});		
	});
};

/*	makeRange()
	Append an input[type="range"] and call drawFrame on change */
BuildWidget.prototype.makeRange = function() {
	var self = this;

	this.rangeInput.attr({
		"type" : "range",
		"min" : 0,
		"max" : this.images.length - 1,
		"step" : "any",
		"value" : this.params.startingValue
	});

	this.range = this.outerWrapper.find(".widget-selector");
	this.range.append(this.rangeInput);
	
	this.rangeInput.bind("input", function() {
		self.params.value = parseFloat(this.value);
		self.drawFrame();
	});
};

/*	drawFrame()
	Draw the image segments onto the canvas and add a white line on the divide */
BuildWidget.prototype.drawFrame = function() {
	var self = this;

	var canvasFullHeight = this.params.height;
	var canvasFullWidth = this.params.width;

	var imageFullWidth = this.params.allImages[1].width;
	var imageFullHeight = this.params.allImages[1].height;

	var leftImage = this.params.allImages[1];
	var rightImage = this.params.allImages[0];

	var leftImageWidth = imageFullWidth * this.params.value;
	var leftCanvasWidth = canvasFullWidth * this.params.value;

	var rightImageX = imageFullWidth * this.params.value;
	var rightImageWidth = imageFullWidth * (1 - this.params.value);
	var rightCanvasX = canvasFullWidth * this.params.value;
	var rightCanvasWidth = canvasFullWidth * (1 - this.params.value);

	this.ctx.clearRect(0,0, canvasFullWidth, canvasFullHeight);

	/*	Check that params.value is greater than 0 so we're not multiplying width by 0
		and less than 1.
	*/
	if (this.params.value > 0 && this.params.value < 1) {
		this.ctx.drawImage(leftImage, 0, 0, leftImageWidth, imageFullHeight, 0, 0, leftCanvasWidth, canvasFullHeight);
		this.ctx.drawImage(rightImage, rightImageX, 0, rightImageWidth, imageFullHeight, rightCanvasX, 0, rightCanvasWidth, canvasFullHeight);
	}  else if (this.params.value >= 1) {
		this.ctx.drawImage(leftImage, 0, 0, imageFullWidth, imageFullHeight, 0, 0, canvasFullWidth, canvasFullHeight);
	}	else {
		/* We can now presume that this.params.value is 0 */
		this.ctx.drawImage(rightImage, 0, 0, imageFullWidth, imageFullHeight, 0, 0, canvasFullWidth, canvasFullHeight);
	}

	this.ctx.beginPath();
	this.ctx.moveTo((canvasFullWidth * this.params.value),0);
	this.ctx.lineTo((canvasFullWidth * this.params.value), canvasFullHeight);
	this.ctx.closePath();
	this.ctx.stroke();
};

/*	Self executing anonymous function to call init()
	once jQuery is loaded */
(function() {
	var init = function($) {

		/* Dummy element to test if input[type="range"] is supported */
		var testInput = document.createElement("input");
		testInput.setAttribute("type", "range");

		/* Dummy element to test if canvas is supported */
		var testCanvas = document.createElement("canvas").getContext;

		var params1 = buildParams();
		var params2 = buildParams();

		var slider1 = new BuildWidget("#slider-1", params1);
		var slider2 = new BuildWidget("#slider-2", params2);

		/*	Check if input[type="range"] and canvas is supported
			otherwise call the whole thing off */
		if (testInput.type !== "text" && testCanvas) {
			slider1.buildCanvas();
			slider2.buildCanvas();

			slider1.loadImages();
			slider2.loadImages();

			slider1.makeRange();
			slider2.makeRange();
		} else {
			slider1.destroy();
			slider2.destroy();
		}

		window.onresize = function () {
			slider1.resizeCanvas();
			slider2.resizeCanvas();
		};
	};

	/*	Before calling init()
		- check jQuery is loaded */
	setTimeout(function() {
		if (typeof jQuery !== 'undefined') {

			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);

})();
</script>
<!--<![endif]-->