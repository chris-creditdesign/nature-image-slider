<!doctype html>
<html lang="en" class="js-enabled">
<!-- <html lang="en" class="js-disabled"> -->
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />

	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=2.2,user-scalable=yes, maximum-scale=10.0">	



</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-middle">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.html-widget {
  border: 1px solid #ececec;
  background-color: #ececec;
}

.html-widget .credit {
  padding: 5px 5px 0;
  margin-bottom: 0;
}

.html-widget .caption {
  padding: 5px 5px 4px;
  margin-bottom: 10px;
}

.outerwrapper {
  width: 100%;
  position: relative;
  background-color: #fff;
}
.outerwrapper h2 {
  margin: 0 10px 0 10px;
  padding: 10px 0 0 0;
}
.outerwrapper p {
  margin: 10px;
  padding: 0;
}
.outerwrapper input {
  width: 100%;
}
.outerwrapper canvas {
  cursor: col-resize;
}
.outerwrapper .widget-images ul {
  padding-left: 0;
}
.outerwrapper .widget-images li {
  list-style: none;
}
.outerwrapper .widget-selector {
  padding: 0 5% 10px;
  margin: 10px 0;
}
.outerwrapper .widget-canvas {
  position: relative;
  margin: 0 5%;
}

</style>
<!--[if gt IE 8]><!-->
<style>
.js-enabled .widget-images {
	display: none;
}
</style>
<!--<![endif]-->
<div class="outerwrapper" id="slider-1">
	<h2>Image slider: Spot the difference</h2>
	<p>Greenland before and after.</p>
	<div class="widget-canvas"></div>
	<div class="widget-selector"></div>
	<div class="widget-images">
	<ul>
		<li>
			<img src="http://www.nature.com/polopoly_fs/7.37812.1468498740!/image/montage-107a.jpg" alt="before"/>
			<p>Before</p>
		</li>
		<li>
			<img src="http://www.nature.com/polopoly_fs/7.37813.1468498809!/image/montage-107b.jpg" alt="after" />
			<p>After</p>
		</li>
	</ul>
		
	</div>
</div>

<p class="credit">Source:</p>

<!--[if gt IE 8]><!-->
<script type="text/javascript">
/*	resize()
	Redraw and resize the canvas */
BuildWidget.prototype.resizeCanvas = function() {
	
	if(jQuery(window).width() != this.params.windowWidth) {
		
		this.params.windowWidth = $(window).width();

		var size = getCanvasSize(this.params.widthAdjustment, this.params.heightRatio);

		this.params.width = size.width;
		this.params.height = size.height;

		this.imageCanvas.attr({
			"width": this.params.width,
			"height": this.params.height
		});

		this.ctx.strokeStyle = "#ffffff";
		this.ctx.lineWidth = 2;

		this.drawFrame();
	}
};
BuildWidget.prototype.buildCanvas = function() {
	var self = this;

	this.imageCanvas.attr({
		"width": self.params.width,
		"height": self.params.height
	});

	this.outerWrapper.find(".widget-canvas")
		.append(self.imageCanvas);

	this.ctx = this.imageCanvas[0].getContext("2d");
	this.ctx.strokeStyle = this.params.strokeStyle;
	this.ctx.lineWidth = this.params.lineWidth;

	$("body").bind(this.params.startEvent, function() {
		self.params.mouseDown = true;
	});

	$("body").bind(this.params.endEvent, function() {
		self.params.mouseDown = false;
	});

	/* Listen for click 'n drag or swiping on the canvas */
	this.imageCanvas.bind(this.params.moveEvent, function (evt) {
		
		var mousePos = self.getMousePos(evt);
		self.params.value = mousePos.x / self.params.width;
		
		if (self.params.mouseDown) {
			self.drawFrame();
			self.rangeInput.prop("value", self.params.value);
		}
		
	});
};
/*	getMousePos(canvas, evt)
	Find out where the finger or the pointer is on the canvas */
BuildWidget.prototype.getMousePos = function(evt) {
	var rect = this.imageCanvas[0].getBoundingClientRect();
	var x,y;
	
	if (this.params.touchSupported) {
		x = evt.originalEvent.targetTouches[0].clientX;
		y = evt.originalEvent.targetTouches[0].clientY;
	} else {
		x = evt.clientX;
		y = evt.clientY;
	}
	
	return {
		x: x - rect.left,
		y: y - rect.top
	};
};

/*	makeSelect()
	Append a select element and call drawFrame on change */
BuildWidget.prototype.makeSelect = function() {
	console.log("Let's call the whole thing off");
};

BuildWidget.prototype.loadImages = function() {
	var self = this;
	this.widgetImages = this.outerWrapper.select(".widget-images");
		
	/*	Select each of the images and push a new img object into
		the allImages array with the relevant src */
	this.images = this.widgetImages.find("img");
	
	var imageCount = this.images.length;

	function checkImagesLoaded() {
		imageCount--;
		
		if (imageCount === 0) {
			self.drawFrame();
		}
	}

	// /* Fill the canvas image with frame 0 as soon as it is ready */
	// allImages[0].onload = checkImagesLoaded();
	// allImages[1].onload = checkImagesLoaded();

	$.each(self.images, function (key, value) {

		var thisImage = new Image();
		thisImage.src = this.src;
		self.params.allImages.push(thisImage);
		
		$(this).error(function(evt) {
			console.log("We have an error!");
		}).load(checkImagesLoaded());
	});
};
/*	makeRange()
	Append an input[type="range"] and call drawFrame on change */
BuildWidget.prototype.makeRange = function() {
	var self = this;

	this.rangeInput.attr({
		"type" : "range",
		"min" : 0,
		"max" : this.images.length - 1,
		"step" : "any",
		"value" : this.params.startingValue
	});

	this.range = this.outerWrapper.find(".widget-selector");
	this.range.append(this.rangeInput);
	
	this.rangeInput.bind("input", function() {
		self.params.value = parseFloat(this.value);
		self.drawFrame();
	});
};

BuildWidget.prototype.drawFrame = function() {
	var self = this;

	var canvasFullHeight = this.params.height;
	var canvasFullWidth = this.params.width;

	var imageFullWidth = this.params.allImages[1].width;
	var imageFullHeight = this.params.allImages[1].height;

	var leftImage = this.params.allImages[1];
	var rightImage = this.params.allImages[0];

	var leftImageWidth = imageFullWidth * this.params.value;
	var leftCanvasWidth = canvasFullWidth * this.params.value;

	var rightImageX = imageFullWidth * this.params.value;
	var rightImageWidth = imageFullWidth * (1 - this.params.value);
	var rightCanvasX = canvasFullWidth * this.params.value;
	var rightCanvasWidth = canvasFullWidth * (1 - this.params.value);

	this.ctx.clearRect(0,0, canvasFullWidth, canvasFullHeight);

	
	/* Check that params.value is greater than 0 so we're not multiplying width by 0 */
	if (this.params.value > 0) {
		this.ctx.drawImage(leftImage, 0, 0, leftImageWidth, imageFullHeight, 0, 0, leftCanvasWidth, canvasFullHeight);
		this.ctx.drawImage(rightImage, rightImageX, 0, rightImageWidth, imageFullHeight, rightCanvasX, 0, rightCanvasWidth, canvasFullHeight);
	} else {
		this.ctx.drawImage(rightImage, 0, 0, imageFullWidth, imageFullHeight, 0, 0, canvasFullWidth, canvasFullHeight);
	}

	
	this.ctx.beginPath();
	this.ctx.moveTo((this.params.width * this.params.value),0);
	this.ctx.lineTo((this.params.width * this.params.value), canvasFullHeight);
	this.ctx.closePath();
	this.ctx.stroke();

};
function buildParams() {
	var params = {};

	/* Array to store the images */
	params.allImages = [];

	/* Store with window Width to stop iOS resizing on scroll */
	params.windowWidth = jQuery(window).width();
	
	params.range = null;
	params.select = null;
	params.startingValue = 0.5;
	params.value = 0.5;
	params.widthAdjustment = 0.9;
	params.heightRatio = 0.6667;
	params.strokeStyle = "#ffffff";
	params.lineWidth = 2;

	var size = getCanvasSize(params.widthAdjustment, params.heightRatio);

	params.width = size.width;
	params.height = size.height;

	params.touchSupported = 'ontouchstart' in window;
	params.startEvent = params.touchSupported ? 'touchstart' : 'mousedown';
	params.moveEvent = params.touchSupported ? 'touchmove' : 'mousemove';
	params.endEvent = params.touchSupported ? 'touchend' : 'mouseup';
	params.mouseDown = false;


	return params;
}

function getCanvasSize(widthAdjustment, heightRatio) {

	var width = Math.floor(jQuery("#content").width() * widthAdjustment);
	var height = Math.floor(width * heightRatio);

	return {
		width: width,
		height: height
	};
}
function BuildWidget(target, params) {
	this.target = target;
	this.params = params;

	this.outerWrapper = jQuery(target);
	this.imageCanvas = jQuery("<canvas></canvas>");
	this.rangeInput = jQuery("<input />");
	this.ctx = null;
}

(function() {
	var init = function($) {

		/* Dummy element to test if input[type="range"] is supported */
		var testInput = document.createElement("input");
		testInput.setAttribute("type", "range");

		var params = buildParams();

		var slider = new BuildWidget("#slider-1", params);

		slider.buildCanvas();
		slider.loadImages();

		/*	call makeRange() if input[type="range"] is supported
			call makeSelect() otherwise */
		if (testInput.type !== "text") {
			slider.makeRange();
		} else {
			slider.makeSelect();
		}

		window.onresize = function () {
			slider.resizeCanvas();
		};

	};

	/*	Before calling init()
		- check jQuery is loaded
		- check the images are hidden */
	setTimeout(function() {
		if (typeof jQuery !== 'undefined') {
			// if (jQuery(".widget-images").css("display") !== "none") {
			// 	jQuery(".widget-images").css("display","none");
			// }
			init(jQuery);
		} else {
			setTimeout(arguments.callee, 60);
		}
	}, 60);

})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>